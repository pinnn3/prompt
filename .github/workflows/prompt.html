<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PINN STUDIO | PROMPT JSON GENERATOR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-btn.active { 
            border-color: #3b82f6; 
            color: #3b82f6;
            background-color: #eff6ff;
        }
        .copy-btn-icon { transition: transform 0.2s ease-in-out; }
        .copy-btn:active .copy-btn-icon { transform: scale(0.9); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">PINN STUDIO | Json Prompt Generator</h1>
            <p class="text-gray-600 mt-2">Masukkan ide cerita Anda dan biarkan AI membuat prompt video yang terperinci.</p>
        </header>

        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="tab-generator-btn" class="tab-btn active whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300 focus:outline-none">
                    Generator
                </button>
                <button id="tab-settings-btn" class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300 focus:outline-none">
                    Pengaturan
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div>
            <!-- Generator Tab -->
            <div id="tab-generator" class="tab-content active">
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-2">
                            <label for="idea" class="block text-sm font-medium text-gray-700 mb-1">Ide Cerita Anda</label>
                            <textarea id="idea" rows="6" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Contoh: Seorang astronot menemukan sebuah planet yang terbuat dari kristal, namun kristal tersebut hidup."></textarea>
                        </div>
                        <div class="space-y-4">
                             <div>
                                <label for="sceneCount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Scene</label>
                                <input type="number" id="sceneCount" value="3" min="1" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition">
                            </div>
                            <div>
                                <label for="videoStyle" class="block text-sm font-medium text-gray-700 mb-1">Gaya Video</label>
                                <select id="videoStyle" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition bg-white">
                                    <option>Default (AI Decides)</option>
                                    <option>3D Animation</option>
                                    <option>2D Animation</option>
                                    <option>Anime</option>
                                    <option>Cyberpunk</option>
                                    <option>Hyper Realistic</option>
                                    <option>Pixar</option>
                                    <option>Claymation (Stop Motion)</option>
                                    <option>Cinematic</option>
                                    <option>Vaporwave</option>
                                    <option>Steampunk</option>
                                    <option>Retro Film</option>
                                    <option>Pixel Art</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 text-right">
                        <button id="generateBtn" class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">
                            <span id="btn-text">Generate</span>
                            <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Output Section -->
                <div id="outputContainer" class="mt-8 space-y-6">
                    <!-- Generated prompts will appear here -->
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="tab-settings" class="tab-content">
                 <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Pengaturan API</h2>
                    <div>
                        <label for="apiKey" class="block text-sm font-medium text-gray-700">API Key Gemini</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <input type="password" id="apiKey" class="block w-full p-3 border border-gray-300 rounded-md pr-10 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan API Key Anda">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <button id="toggleApiKeyVisibility" type="button" class="text-gray-400 hover:text-gray-600">
                                    <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                      <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                      <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                                    </svg>
                                    <svg id="eye-off-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2.003 2.003 0 012.45 2.45l1.514 1.514a4 4 0 00-5.478-5.478z" clip-rule="evenodd" />
                                        <path d="M12.454 16.697L9.75 13.992a4 4 0 01-3.742-3.741L2.303 6.546A10.048 10.048 0 01.458 10c1.274 4.057 5.022 7 9.542 7 1.452 0 2.848-.346 4.126-.944l-1.67-1.67z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 text-right">
                        <button id="saveApiKeyBtn" class="px-5 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300">Simpan</button>
                    </div>
                    <p id="save-status" class="text-sm text-green-600 mt-2 h-4"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tabs = {
                generator: { btn: document.getElementById('tab-generator-btn'), content: document.getElementById('tab-generator') },
                settings: { btn: document.getElementById('tab-settings-btn'), content: document.getElementById('tab-settings') }
            };
            const ideaEl = document.getElementById('idea');
            const sceneCountEl = document.getElementById('sceneCount');
            const videoStyleEl = document.getElementById('videoStyle');
            const generateBtn = document.getElementById('generateBtn');
            const outputContainer = document.getElementById('outputContainer');
            const loadingSpinner = document.getElementById('loading-spinner');
            const btnText = document.getElementById('btn-text');
            const apiKeyEl = document.getElementById('apiKey');
            const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
            const saveStatusEl = document.getElementById('save-status');
            const toggleApiKeyVisibilityBtn = document.getElementById('toggleApiKeyVisibility');
            const eyeIcon = document.getElementById('eye-icon');
            const eyeOffIcon = document.getElementById('eye-off-icon');

            // --- Tab Logic ---
            Object.values(tabs).forEach(tab => {
                tab.btn.addEventListener('click', () => {
                    Object.values(tabs).forEach(t => {
                        t.btn.classList.remove('active');
                        t.content.classList.remove('active');
                    });
                    tab.btn.classList.add('active');
                    tab.content.classList.add('active');
                });
            });

            // --- API Key Logic ---
            apiKeyEl.value = localStorage.getItem('geminiApiKey') || '';

            saveApiKeyBtn.addEventListener('click', () => {
                const key = apiKeyEl.value.trim();
                if(key) {
                    localStorage.setItem('geminiApiKey', key);
                    saveStatusEl.textContent = 'API Key berhasil disimpan!';
                } else {
                    localStorage.removeItem('geminiApiKey');
                    saveStatusEl.textContent = 'API Key dihapus.';
                }
                setTimeout(() => saveStatusEl.textContent = '', 2000);
            });

            toggleApiKeyVisibilityBtn.addEventListener('click', () => {
                const isPassword = apiKeyEl.type === 'password';
                apiKeyEl.type = isPassword ? 'text' : 'password';
                eyeIcon.classList.toggle('hidden', isPassword);
                eyeOffIcon.classList.toggle('hidden', !isPassword);
            });

            // --- Generation Logic ---
            generateBtn.addEventListener('click', async () => {
                const idea = ideaEl.value.trim();
                const sceneCount = parseInt(sceneCountEl.value, 10);
                const videoStyle = videoStyleEl.value;
                const apiKey = localStorage.getItem('geminiApiKey') || '';

                if (!idea) {
                    alert('Mohon masukkan ide cerita terlebih dahulu.');
                    return;
                }
                if (isNaN(sceneCount) || sceneCount < 1) {
                    alert('Jumlah scene harus berupa angka dan minimal 1.');
                    return;
                }
                if (!apiKey) {
                    alert('Mohon masukkan API Key di tab Pengaturan.');
                    tabs.settings.btn.click(); // Switch to settings tab
                    return;
                }

                setLoadingState(true);
                outputContainer.innerHTML = '';

                try {
                    const systemPrompt = createSystemPrompt(idea, sceneCount, videoStyle);
                    const result = await callGeminiApi(systemPrompt, apiKey);
                    
                    if (result && result.candidates && result.candidates.length > 0) {
                        const textResponse = result.candidates[0].content.parts[0].text;
                        const jsonResponses = textResponse.split('---JSON_SCENE_SEPARATOR---');
                        
                        jsonResponses.forEach((jsonString, index) => {
                            if (jsonString.trim()) {
                                displayScene(jsonString, index + 1);
                            }
                        });
                    } else {
                        displayError('Gagal mendapatkan respons dari AI. Coba lagi.');
                    }
                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    displayError(`Terjadi kesalahan: ${error.message}`);
                } finally {
                    setLoadingState(false);
                }
            });

            function setLoadingState(isLoading) {
                if (isLoading) {
                    generateBtn.disabled = true;
                    btnText.classList.add('hidden');
                    loadingSpinner.classList.remove('hidden');
                } else {
                    generateBtn.disabled = false;
                    btnText.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                }
            }
            
            async function callGeminiApi(prompt, apiKey, retries = 3, delay = 1000) {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                };

                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                        });

                        if (!response.ok) {
                            const errorBody = await response.json();
                            throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody.error?.message || 'Unknown error'}`);
                        }

                        return await response.json();
                    } catch (error) {
                        if (i === retries - 1) throw error;
                        await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                    }
                }
            }


            function createSystemPrompt(idea, sceneCount, videoStyle) {
                const jsonStructure = `{
    "scene_id": "", "duration_sec": "", "narrative": "", "visual_style": "",
    "character_lock": [{"CHAR_A": {"name": "","species": "","gender": "","age": "","weight": "","body_build": "","face_shape": "","hair": "","facial_hair": "","skin_or_fur_color": "","outfit_top": "","outfit_bottom": "","helmet_or_hat": "","shoes_or_footwear": "","props": "","character_scale": "","unique_marks": "","position": "","orientation": "","pose": "","foot_placement": "","hand_detail": "","expression": "","action_flow": {"pre_action": "","approach_action": "","interaction_action": "","main_action": "","reaction_action": "","post_action": "","micro_transition": ""},"camera_support_motion": ""}}],
    "background_lock": {"setting": "","scenery": "","props": "","time_of_day": "","lighting": ""},
    "camera": {"framing": "","angle": "","movement": ""},
    "visual_effects": {"weather": "","lighting_fx": ""},
    "foley_and_ambience": {"ambience": [],"fx": [],"non_diegetic_music": ""},
    "dialogue": [{"speaker": "","voice": "","language": "","line": ""}]
}`;
                return `Anda adalah seorang sutradara film dan penulis skenario ahli. Tugas Anda adalah membuat prompt terperinci untuk model AI text-to-video.
Berdasarkan ide cerita pengguna, buatlah ${sceneCount} prompt adegan yang berurutan.Setiap scene berdurasi 8 detik

Ide cerita pengguna: "${idea}"

ATURAN WAJIB:
1.  **KONSISTENSI KARAKTER (SANGAT PENTING):** Karakter utama (misal: CHAR_A) HARUS tetap konsisten di semua adegan. Deskripsi fisik (spesies, penampilan, pakaian, dll.) yang Anda buat untuk karakter di scene_1 HARUS DIGUNAKAN KEMBALI untuk karakter yang sama di scene_2, scene_3, dan seterusnya. Anggap \`character_lock\` sebagai profil karakter yang tidak berubah kecuali narasi secara eksplisit menuntut perubahan (misalnya, karakter berganti pakaian).
2.  **GAYA VISUAL:** Gunakan gaya visual berikut untuk semua adegan: "${videoStyle}". Ini harus tercermin dalam field \`visual_style\` dan juga mempengaruhi deskripsi dalam \`narrative\`, \`scenery\`, dan \`lighting\`. Jika gaya adalah 'Default (AI Decides)', Anda bebas memilih gaya yang paling sesuai.
3.  **STRUKTUR JSON:** Untuk SETIAP adegan, Anda HARUS menghasilkan objek JSON yang valid dan lengkap yang secara KETAT mengikuti struktur di bawah. Jangan tambahkan komentar atau teks lain di luar objek JSON.
4.  **NARASI:** Isi setiap field dalam JSON secara kreatif untuk membangun cerita yang mengalir dari satu adegan ke adegan berikutnya. \`scene_id\` harus dalam format "scene_1", "scene_2", dst.
5.  **DIALOG:** Gunakan dialog setiap detik 6-8 detik setiap scene
6.  **MAKSIMAL SETIAP SCENE 8 DETIK :** Setiap scene berdurasi 8 detik

Struktur JSON yang wajib diikuti:
${jsonStructure}

PENTING: Setelah setiap objek JSON untuk satu adegan, gunakan pemisah unik '---JSON_SCENE_SEPARATOR---'. Jangan letakkan pemisah ini setelah adegan terakhir.
Contoh output untuk 2 adegan:
{...JSON untuk scene_1...}
---JSON_SCENE_SEPARATOR---
{...JSON untuk scene_2...}
`;
            }

            function displayScene(jsonString, sceneNumber) {
                let formattedJson;
                let isValidJson = true;
                try {
                    // Clean up potential markdown formatting from the AI response
                    const cleanedJsonString = jsonString.trim().replace(/^```json\n/, '').replace(/\n```$/, '');
                    const parsed = JSON.parse(cleanedJsonString);
                    formattedJson = JSON.stringify(parsed, null, 2);
                } catch (e) {
                    isValidJson = false;
                    formattedJson = jsonString;
                }

                const card = document.createElement('div');
                card.className = 'bg-white p-5 rounded-lg shadow-md border border-gray-200';
                
                const header = document.createElement('div');
                header.className = 'flex justify-between items-center mb-4';

                const title = document.createElement('h3');
                title.className = 'text-lg font-semibold text-gray-800';
                title.textContent = `Scene ${sceneNumber}`;
                
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-btn p-2 rounded-md bg-gray-100 hover:bg-gray-200 text-gray-600 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500';
                copyButton.innerHTML = `<svg class="copy-btn-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`;
                copyButton.title = 'Copy JSON';
                
                copyButton.addEventListener('click', () => {
                    const textarea = document.createElement('textarea');
                    textarea.value = formattedJson;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    
                    copyButton.innerHTML = `<svg class="h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`;
                    setTimeout(() => {
                         copyButton.innerHTML = `<svg class="copy-btn-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`;
                    }, 1500);
                });

                header.appendChild(title);
                header.appendChild(copyButton);

                const pre = document.createElement('pre');
                pre.className = 'bg-gray-900 text-white p-4 rounded-md text-sm overflow-x-auto';
                if (!isValidJson) {
                     pre.classList.add('text-red-400');
                }
                
                const code = document.createElement('code');
                code.textContent = formattedJson;
                
                pre.appendChild(code);
                card.appendChild(header);
                card.appendChild(pre);
                outputContainer.appendChild(card);
            }

            function displayError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative';
                errorDiv.role = 'alert';
                errorDiv.innerHTML = `<strong class="font-bold">Error!</strong><span class="block sm:inline ml-2">${message}</span>`;
                outputContainer.appendChild(errorDiv);
            }
        });
    </script>
</body>
</html>

